<!DOCTYPE html>
	<!DOCTYPE html>
	<html>
		<head>
			<title>Canvas Thomas Refined</title>
			<style>
				canvas {
					border: 1px solid black;
				}
			</style>
		</head>
		<body>
			<div>
		    	<button onclick="NewItem()">Start</button>
				<script src="convoyeur.js"></script>
				<script src="generateur.js"></script>
			</div>
			<div>
				<canvas id="canvas" width="800" height="800"></canvas>
			</div>
		</body>

		<script>

			var CLOCK = 75;
			var ClockGenerateur = 5000;
			var Xgenerateur = 0, Ygenerateur = 50, TailleGenerateur = 50;
			var mouvement = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; 
			var tailleCube=TailleGenerateur/2;
			var Yconvoyeur = Ygenerateur + TailleGenerateur + 100;

			//Stockage de la position des objets
			var max = 50;
			let Positions = [
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['',''],
			['',''],['',''],['',''],['',''],['','']
			];

			//Ici on place tous les elements de la simulation
			function init(){
  				var ctx = document.getElementById('canvas').getContext('2d'); 
				Generateur(Xgenerateur,Ygenerateur,TailleGenerateur,1,ctx, Positions);
  				FirstConvoyeur(10,150,150,1,ctx,Positions,mouvement,tailleCube);
  				FirstConvoyeur(190,150,100,1,ctx,Positions,mouvement,tailleCube);
			}

			function clock(){
  				var ctx = document.getElementById('canvas').getContext('2d'); 
 				
 				Deplacement(Positions)

 				//Actualise toutes les nouvelles positions
 				for (let i = 0; i < max; i++){
			 		if (Positions[i][0] > 0 && Positions[i][0] < canvas.width){
			 			//Enleve l'ancien objet
  						ctx.clearRect(Positions[i][0]-1, Positions[i][1]-2, TailleGenerateur/2+1, TailleGenerateur/2+3);
					 	//Créer l'objet avec sa nouvelle position
					 	ctx.fillStyle = 'green';  
					 	ctx.fillRect(Positions[i][0], Positions[i][1], TailleGenerateur/2, TailleGenerateur/2);
					 	ctx.fillStyle = 'white';
						ctx.font = '20px serif';
  						ctx.fillText(i + 1, Positions[i][0], Positions[i][1] + 5 + TailleGenerateur/4);
				 	}
			 	}
  				setTimeout(function(){clock()},CLOCK);
			}

			window.onload = init;
			window.requestAnimationFrame(clock);

			//Gere le deplacement en fonction des éléments se trouvant aux alentours
			function Deplacement(Positions){
				var x, y;
				var ctx = document.getElementById('canvas').getContext('2d'); 
				Convoyeur(10,150,150,1,ctx,Positions,mouvement,tailleCube);
				Convoyeur(190,150,100,1,ctx,Positions,mouvement,tailleCube);
				for (let i = 0; i < max; i++){
 						if((mouvement[i]==0) && (Positions[i][0]!='') && (Positions[i][1]!='')){
 							x = Positions[i][0];
			                y = Positions[i][1];
			                Positions[i] = [x, y + 1];
			                mouvement[1]==1;
 						}
			 	}
				for (let i = 0; i < max; i++){
 						mouvement[i]=0;
			 	}
			}

			//Ajoute un element et enregistre ses coordonnées
			var nbCube = 0;
			function NewItem(){
				var x = Xgenerateur, y = Ygenerateur, tailleCube = TailleGenerateur/2;
  				var ctx = document.getElementById('canvas').getContext('2d'); 
				if (nbCube < max){
					ctx.fillStyle = 'green';
					ctx.fillRect(x + 12, y + tailleCube/2 + 1, tailleCube, tailleCube);
				 	for (let i = 0; i < max; i++){
				 		//Dès qu'un emplacement est libre
				 		if (Positions[i][0] == ''){
				 			Positions[i][0] = x + 12;
				 			Positions[i][1] = y + tailleCube/2 + 1;
				 			nbCube++;
				 			break;
				 		}
				 	}
				}
			 	setTimeout(function(){NewItem()},ClockGenerateur);
			}
		</script>
	</body>
</html>
